<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>í•­ê³µí¸ ë¦¬ìŠ¤íŠ¸</title>
  <link rel="stylesheet" href="CSS/flight_list.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>
<body>
  <header class="list-header">
    <div class="logo" id="logoLink">ğŸŒJaeWonFlight</div>
    <h2>í•­ê³µí¸ ë¦¬ìŠ¤íŠ¸</h2>
    <nav class="main-nav">
      <ul id="authLinks">
        <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ì—¬ê¸°ì— ë²„íŠ¼ì´ ì¶”ê°€ë©ë‹ˆë‹¤ -->
      </ul>
    </nav>
  </header>

  <div class="flight-list" id="flightList">
    <!-- ë™ì  ì½˜í…ì¸ ê°€ ì—¬ê¸°ì— ì¶”ê°€ë  ì˜ˆì • -->
  </div>

<script>
    function goToMainPage() {
        window.location.href = "main.html";
    }
      
    document.querySelector('.logo').onclick = function() {
        goToMainPage();
    };

// ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ì¸ì¦ ë§í¬ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
document.addEventListener('DOMContentLoaded', function() {
  checkLoginStatus();
  loadFlights();
  updateSeatsPeriodically();
});

function checkLoginStatus() {
  const authLinks = document.getElementById('authLinks');
  
  // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
  if (localStorage.getItem('authToken')) {
    // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ì•ˆì „í•˜ê²Œ ë™ì ìœ¼ë¡œ ì¶”ê°€í•˜ê¸° ìœ„í•´, 
    // createElementì™€ appendChildë¥¼ ì‚¬ìš©í•  ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.
    var logoutLi = document.createElement('li');
    var logoutLink = document.createElement('a');
    logoutLink.href = "#";
    logoutLink.id = "logoutButton";
    logoutLink.textContent = "ë¡œê·¸ì•„ì›ƒ";
    logoutLink.addEventListener('click', function() {
      localStorage.removeItem('authToken');
      window.location.reload();
    });
    logoutLi.appendChild(logoutLink);
    authLinks.appendChild(logoutLi);

 // ë‚˜ì˜ ì˜ˆì•½ ì •ë³´ ë²„íŠ¼ ì¶”ê°€
    var reservationLi = document.createElement('li');
    var reservationLink = document.createElement('a');
    reservationLink.href = "reservation_info.html"; // ì˜ˆì•½ ì •ë³´ í˜ì´ì§€ë¡œ ê°€ëŠ” ê²½ë¡œ ì„¤ì •
    reservationLink.id = "reservationInfo";
    reservationLink.textContent = "ë‚˜ì˜ ì˜ˆì•½ ì •ë³´";
    reservationLi.appendChild(reservationLink);
    authLinks.appendChild(reservationLi);
  } else {
    // ë¡œê·¸ì¸ ë° íšŒì›ê°€ì… ë²„íŠ¼ ìƒì„±
    authLinks.innerHTML = '<li><a id="loginButton" href="#">ë¡œê·¸ì¸</a></li><li><a href="signup.html">íšŒì›ê°€ì…</a></li>';

    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•˜ëŠ” ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
document.getElementById('loginButton').addEventListener('click', function() {
  // í˜„ì¬ í˜ì´ì§€ì˜ URLì„ sessionStorageì— 'returnUrl'ì´ë¼ëŠ” í‚¤ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
  sessionStorage.setItem('returnUrl', window.location.href);
  window.location.href = 'login.html'; // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
});
  }
}



  // í˜ì´ì§€ ë¡œë“œ ì‹œ í•­ê³µí¸ ëª©ë¡ ë¡œë“œ
  document.addEventListener('DOMContentLoaded', function() {
    loadFlights();
    updateSeatsPeriodically();
  });

  function loadFlights() {
    const flightsData = sessionStorage.getItem('searchResults');
    if (flightsData) {
      try {
        // ì²« ë²ˆì§¸ JSON.parseëŠ” ì™¸ë¶€ JSONì„ íŒŒì‹±
        const response = JSON.parse(flightsData);
        // ë‘ ë²ˆì§¸ JSON.parseëŠ” ë‚´ë¶€ body ë¬¸ìì—´ì„ íŒŒì‹±
        const flights = JSON.parse(response.body);
        if (Array.isArray(flights)) {
          displayFlights(flights);
        } else {
          throw new Error('Body is not an array');
        }
      } catch (error) {
        console.error('Error parsing flights data:', error);
        document.getElementById('flightList').innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>';
      }
    } else {
      document.getElementById('flightList').innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
    }
  }
  

  function displayFlights(flights) {
    const flightListElement = document.getElementById('flightList');
    flightListElement.innerHTML = '';

    flights.forEach(flight => {
      const flightElement = document.createElement('div');
      flightElement.classList.add('flight');
      flightElement.innerHTML = `
        <h3>í•­ê³µì‚¬: ${flight.airline}</h3>
        <p>ì¶œë°œì§€: ${flight.departure}</p>
        <p>ë„ì°©ì§€: ${flight.destination}</p>
        <p>ê°€ê²©: ${flight.price}ë§Œì›</p>
        <p>ì˜ˆì•½ ê°€ëŠ¥ ì¢Œì„: ${flight.seatsAvailable}ì„</p>
        <button class="reserve-button" data-flight-id="${flight.Number}">ì˜ˆì•½í•˜ê¸°</button>
      `;
      flightListElement.appendChild(flightElement);

       // ì˜ˆì•½í•˜ê¸° ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ì¶”ê°€í•˜ì—¬ í´ë¦­ ì‹œ ì˜ˆì•½ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.
       const reserveButton = flightElement.querySelector('.reserve-button');
       reserveButton.addEventListener('click', function() {
         goToReservationPage(flight);
       });
    });
  }

  function goToReservationPage(flight) {
    sessionStorage.setItem('selectedFlight', JSON.stringify(flight));
    console.log('Saving to sessionStorage:', flight);
    window.location.href = 'reservation.html';
  }

  function updateSeatsPeriodically() {
    const apiEndpoint = 'https://vhdwppucl9.execute-api.ap-northeast-2.amazonaws.com/Get_flightlist/flightlist';
    setInterval(() => {
      fetch(apiEndpoint)
        .then(response => {
          if (!response.ok) {
            throw new Error('Network response was not ok');
          }
          return response.json();
        })
        .then(data => {
          try {
            const flights = JSON.parse(data.body);
            if (Array.isArray(flights)) {
              displayFlights(flights);
            } else {
              console.error('Received data is not an array');
            }
          } catch (error) {
            console.error('Error parsing flights data:', error);
          }
        })
        .catch(error => {
          console.error('Error updating flight seats:', error);
        });
    }, 20000); // 30ì´ˆë§ˆë‹¤ ê°±ì‹ 
  }

  </script>
</body>
</html>
